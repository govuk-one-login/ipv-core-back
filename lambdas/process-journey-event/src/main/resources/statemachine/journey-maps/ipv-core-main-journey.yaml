# Entry points

INITIAL_IPV_JOURNEY:
  events:
    next:
      targetState: CHECK_EXISTING_IDENTITY

# Journey states

CHECK_EXISTING_IDENTITY:
  response:
    type: process
    lambda: check-existing-identity
  events:
    ipv-gpg45-medium:
      targetJourney: NEW_P2_IDENTITY
      targetState: START
    reset-identity:
      targetState: RESET_IDENTITY
    reset-gpg45-identity:
      targetState: RESET_GPG45_IDENTITY
    reuse:
      targetJourney: REUSE_EXISTING_IDENTITY
      targetState: START
    operational-profile-reuse:
      targetJourney: OPERATIONAL_PROFILE_REUSE
      targetState: START
    in-migration-reuse:
      targetJourney: OPERATIONAL_PROFILE_MIGRATION
      targetState: START
    pending:
      targetJourney: F2F_PENDING
      targetState: PENDING
    fail-with-ci:
      targetJourney: FAILED
      targetState: FAILED
    f2f-fail:
      targetJourney: F2F_FAILED
      targetState: FAILED
    error:
      targetJourney: TECHNICAL_ERROR
      targetState: ERROR
    enhanced-verification:
      targetJourney: NEW_P2_IDENTITY
      targetState: ENHANCED_VERIFICATION

RESET_IDENTITY:
  response:
    type: process
    lambda: reset-identity
    lambdaInput:
      isUserInitiated: false
      deleteOnlyGPG45VCs: false
  events:
    next:
      targetJourney: NEW_P2_IDENTITY
      targetState: START

RESET_GPG45_IDENTITY:
  response:
    type: process
    lambda: reset-identity
    lambdaInput:
      isUserInitiated: false
      deleteOnlyGPG45VCs: true
  events:
    next:
      targetJourney: NEW_P2_IDENTITY
      targetState: START

## Legacy journey states
## TODO: PYIC-4459 Delete everything below here once no active sessions require them

# parent states
END_JOURNEY:
  events:
    next:
      targetState: END

CRI_STATE:
  events:
    not-found:
      targetState: PYI_NO_MATCH
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_NO_MATCH
    fail-with-no-ci:
      targetState: PYI_NO_MATCH
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_NO_MATCH
    error:
      targetState: ERROR
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_ERROR
    access-denied:
      targetState: PYI_NO_MATCH
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_NO_MATCH
    enhanced-verification:
      targetState: PYI_NO_MATCH
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_NO_MATCH
    temporarily-unavailable:
      targetState: ERROR
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_ERROR
    fail-with-ci:
      targetState: PYI_NO_MATCH
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_NO_MATCH
    vcs-not-correlated:
      targetState: PYI_NO_MATCH
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_NO_MATCH

CRI_TICF_STATE:
  events:
    enhanced-verification:
      targetState: PYI_NO_MATCH
    fail-with-ci:
      targetState: PYI_NO_MATCH
    error:
      targetState: ERROR

# Shared states

F2F_START_PAGE:
  response:
    type: page
    pageId: page-ipv-identity-postoffice-start
  events:
    next:
      targetState: CRI_CLAIMED_IDENTITY_J4
    end:
      targetState: BANK_ACCOUNT_START_PAGE
      checkIfDisabled:
        bav:
          targetState: PYI_ESCAPE

F2F_PYI_POST_OFFICE:
  response:
    type: page
    pageId: pyi-post-office
  events:
    next:
      targetState: CRI_CLAIMED_IDENTITY_J4
    end:
      targetState: BANK_ACCOUNT_START_PAGE
      checkIfDisabled:
        bav:
          targetState: PYI_ESCAPE

BANK_ACCOUNT_START_PAGE:
  response:
    type: page
    pageId: page-ipv-bank-account-start
  events:
    next:
      targetState: CRI_CLAIMED_IDENTITY_M2B
    end:
      targetState: PYI_ESCAPE

IPV_IDENTITY_REUSE_PAGE:
  response:
    type: page
    pageId: page-ipv-reuse
  parent: END_JOURNEY

OPERATIONAL_PROFILE_REUSE_PAGE:
  response:
    type: page
    pageId: page-ipv-reuse
    context: operational-profile
  parent: END_JOURNEY

# User initiated details delete for f2f journey. Hidden behind deleteDetailsEnabled feature flag.
IPV_IDENTITY_PENDING_PAGE_TEST:
  response:
    type: page
    context: f2f-delete-details
    pageId: page-ipv-pending
  events:
    next:
      targetState: PYI_F2F_DELETE_PAGE

IPV_IDENTITY_PENDING_PAGE:
  response:
    type: page
    pageId: page-ipv-pending
  events:
    next:
      targetState: END

IPV_IDENTITY_START_PAGE:
  response:
    type: page
    pageId: page-ipv-identity-document-start
  events:
    next:
      targetState: CRI_DCMAW
      checkIfDisabled:
        dcmaw:
          targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
          checkIfDisabled:
            f2f:
              targetState: MULTIPLE_DOC_CHECK_PAGE
    end:
      targetState: F2F_START_PAGE
      checkIfDisabled:
        f2f:
          targetState: PYI_ANOTHER_WAY
          checkFeatureFlag:
            ticfCriBeta:
              targetState: CRI_TICF_BEFORE_ANOTHER_WAY

CRI_F2F:
  response:
    type: cri
    criId: f2f
  parent: CRI_STATE
  events:
    next:
      targetState: F2F_HANDOFF_PAGE
    enhanced-verification:
      targetState: F2F_HANDOFF_PAGE
    access-denied:
      targetState: PYI_ANOTHER_WAY
    not-found:
      targetState: PYI_NO_MATCH
    fail-with-no-ci:
      targetState: PYI_NO_MATCH
    fail-with-ci:
      targetState: PYI_NO_MATCH
    vcs-not-correlated:
      targetState: PYI_NO_MATCH
    error:
      targetState: ERROR
    temporarily-unavailable:
      targetState: ERROR

F2F_HANDOFF_PAGE:
  response:
    type: page
    pageId: page-face-to-face-handoff

PYI_ANOTHER_WAY:
  response:
    type: page
    pageId: pyi-another-way
  parent: END_JOURNEY

CRI_DCMAW:
  response:
    type: cri
    criId: dcmaw
  parent: CRI_STATE
  events:
    next:
      targetState: POST_DCMAW_SUCCESS_PAGE
    not-found:
      targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
      checkIfDisabled:
        f2f:
          targetState: MULTIPLE_DOC_CHECK_PAGE
    access-denied:
      targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
      checkIfDisabled:
        f2f:
          targetState: MULTIPLE_DOC_CHECK_PAGE
    temporarily-unavailable:
      targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
      checkIfDisabled:
        f2f:
          targetState: MULTIPLE_DOC_CHECK_PAGE
    fail-with-no-ci:
      targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
      checkIfDisabled:
        f2f:
          targetState: MULTIPLE_DOC_CHECK_PAGE

MULTIPLE_DOC_CHECK_PAGE:
  response:
    type: page
    pageId: page-multiple-doc-check
  events:
    ukPassport:
      targetState: CRI_UK_PASSPORT_J2
    drivingLicence:
      targetState: CRI_DRIVING_LICENCE_J3
    end:
      targetState: END

MULTIPLE_DOC_F2F_CHECK_PAGE:
  response:
    type: page
    context: f2f
    pageId: page-multiple-doc-check
  events:
    ukPassport:
      targetState: CRI_UK_PASSPORT_J2
    drivingLicence:
      targetState: CRI_DRIVING_LICENCE_J3
    end:
      targetState: F2F_PYI_POST_OFFICE

PYI_NO_MATCH:
  response:
    type: page
    pageId: pyi-no-match
  parent: END_JOURNEY

PYI_F2F_TECHNICAL:
  response:
    type: page
    pageId: pyi-f2f-technical
  events:
    next:
      targetState: RESET_IDENTITY
    end:
      targetState: END

PYI_ESCAPE:
  response:
    type: page
    pageId: pyi-escape
  events:
    next:
      targetState: RESET_IDENTITY
    end:
      targetState: END

PYI_CRI_ESCAPE:
  response:
    type: page
    pageId: pyi-cri-escape
  events:
    dcmaw:
      targetState: CRI_DCMAW_PYI_ESCAPE
    f2f:
      targetState: CRI_F2F
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_F2F

PYI_CRI_ESCAPE_NO_F2F:
  response:
    type: page
    pageId: pyi-cri-escape-no-f2f
  events:
    next:
      targetState: CRI_DCMAW_PYI_ESCAPE
    end:
      targetState: END

ERROR:
  response:
    type: error
    pageId: pyi-technical
    statusCode: 500
  parent: END_JOURNEY

CORE_SESSION_TIMEOUT:
  response:
    type: page
    pageId: pyi-timeout-unrecoverable
  parent: END_JOURNEY

EVALUATE_GPG45_SCORES:
  response:
    type: process
    lambda: evaluate-gpg45-scores
  events:
    met:
      targetState: IPV_SUCCESS_PAGE
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_SUCCESS
    unmet:
      targetState: PYI_NO_MATCH
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_NO_MATCH
    vcs-not-correlated:
      targetState: PYI_NO_MATCH
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_NO_MATCH

IPV_SUCCESS_PAGE:
  response:
    type: page
    pageId: page-ipv-success
  parent: END_JOURNEY

END:
  response:
    type: process
    lambda: build-client-oauth-response

CRI_TICF_BEFORE_SUCCESS:
  response:
    type: process
    lambda: call-ticf-cri
  parent: CRI_TICF_STATE
  events:
    next:
      targetState: IPV_SUCCESS_PAGE

CRI_TICF_BEFORE_REUSE:
  response:
    type: process
    lambda: call-ticf-cri
  parent: CRI_TICF_STATE
  events:
    next:
      targetState: IPV_IDENTITY_REUSE_PAGE
      checkFeatureFlag:
        deleteDetailsEnabled:
          targetState: IPV_IDENTITY_REUSE_PAGE_TEST

CRI_TICF_BEFORE_OPERATIONAL_PROFILE_REUSE:
  response:
    type: process
    lambda: call-ticf-cri
  parent: CRI_TICF_STATE
  events:
    next:
      targetState: OPERATIONAL_PROFILE_REUSE_PAGE

CRI_TICF_BEFORE_END:
  response:
    type: process
    lambda: call-ticf-cri
  parent: CRI_TICF_STATE
  events:
    next:
      targetState: END

CRI_TICF_BEFORE_F2F:
  response:
    type: process
    lambda: call-ticf-cri
  parent: CRI_TICF_STATE
  events:
    next:
      targetState: CRI_F2F
    enhanced-verification:
      targetState: CRI_F2F

CRI_TICF_BEFORE_NO_MATCH:
  response:
    type: process
    lambda: call-ticf-cri
  parent: CRI_TICF_STATE
  events:
    next:
      targetState: PYI_NO_MATCH

CRI_TICF_BEFORE_ANOTHER_WAY:
  response:
    type: process
    lambda: call-ticf-cri
  parent: CRI_TICF_STATE
  events:
    next:
      targetState: PYI_ANOTHER_WAY
    enhanced-verification:
      targetState: PYI_ANOTHER_WAY

CRI_TICF_BEFORE_ERROR:
  response:
    type: process
    lambda: call-ticf-cri
  parent: CRI_TICF_STATE
  events:
    next:
      targetState: ERROR
    enhanced-verification:
      targetState: ERROR

# Common pages
PRE_EXPERIAN_KBV_TRANSITION_PAGE:
  response:
    type: page
    pageId: page-pre-experian-kbv-transition
  events:
    next:
      targetState: CRI_EXPERIAN_KBV

CRI_EXPERIAN_KBV:
  response:
    type: cri
    criId: kbv
  parent: CRI_STATE
  events:
    fail-with-no-ci:
      targetState: PYI_CRI_ESCAPE
      checkIfDisabled:
        f2f:
          targetState: PYI_CRI_ESCAPE_NO_F2F
    next:
      targetState: EVALUATE_GPG45_SCORES
    enhanced-verification:
      targetState: MITIGATION_02_OPTIONS_WITH_F2F
      checkIfDisabled:
        f2f:
          targetState: MITIGATION_02_OPTIONS

# User initiated details delete
IPV_IDENTITY_REUSE_PAGE_TEST:
  response:
    type: page
    pageId: page-ipv-reuse
  parent: END_JOURNEY
  events:
    next:
      targetState:
        PYI_NEW_DETAILS_PAGE

PYI_F2F_DELETE_PAGE:
  response:
    type: page
    pageId: pyi-f2f-delete-details
  parent: END_JOURNEY
  events:
    next:
      targetState:
        PYI_F2F_CONFIRM_DELETE_DETAILS_PAGE
    end:
      targetState:
        IPV_IDENTITY_PENDING_PAGE_TEST

PYI_F2F_CONFIRM_DELETE_DETAILS_PAGE:
  response:
    type: page
    context: f2f
    pageId: pyi-confirm-delete-details
  events:
    next:
      targetState:
        RESET_IDENTITY_USER_INITIATED_F2F
    end:
      targetState:
        IPV_IDENTITY_PENDING_PAGE_TEST

PYI_NEW_DETAILS_PAGE:
  response:
    type: page
    pageId: pyi-new-details
  events:
    next:
      targetState:
        PYI_CONFIRM_DELETE_DETAILS_PAGE
    end:
      targetState: IPV_IDENTITY_REUSE_PAGE

PYI_CONFIRM_DELETE_DETAILS_PAGE:
  response:
    type: page
    pageId: pyi-confirm-delete-details
  events:
    next:
      targetState:
        RESET_IDENTITY_USER_INITIATED
    end:
      targetState: IPV_IDENTITY_REUSE_PAGE

RESET_IDENTITY_USER_INITIATED:
  response:
    type: process
    lambda: reset-identity
    lambdaInput:
      isUserInitiated: true
      deleteOnlyGPG45VCs: false
  events:
    next:
      targetState: PYI_DETAILS_DELETED_PAGE

PYI_DETAILS_DELETED_PAGE:
  response:
    type: page
    pageId: pyi-details-deleted
  events:
    next:
      targetState:
        IPV_IDENTITY_START_PAGE

RESET_IDENTITY_USER_INITIATED_F2F:
  response:
    type: process
    lambda: reset-identity
    lambdaInput:
      isUserInitiated: true
      deleteOnlyGPG45VCs: false
  events:
    next:
      targetState: PYI_DETAILS_DELETED_PAGE_F2F

PYI_DETAILS_DELETED_PAGE_F2F:
  response:
    type: page
    context: f2f
    pageId: pyi-details-deleted
  events:
    next:
      targetState:
        IPV_IDENTITY_START_PAGE


# DCMAW journey (J1)
POST_DCMAW_SUCCESS_PAGE:
  response:
    type: page
    pageId: page-dcmaw-success
  events:
    next:
      targetState: ADDRESS_AND_FRAUD_J1

ADDRESS_AND_FRAUD_J1:
  nestedJourney: ADDRESS_AND_FRAUD
  exitEvents:
    next:
      targetState: EVALUATE_GPG45_SCORES
    enhanced-verification:
      targetState: PYI_NO_MATCH
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_NO_MATCH

# Passport journey (J2)
CRI_UK_PASSPORT_J2:
  response:
    type: cri
    criId: ukPassport
  parent: CRI_STATE
  events:
    next:
      targetState: ADDRESS_AND_FRAUD_J2
    access-denied:
      targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
      checkIfDisabled:
        f2f:
          targetState: MULTIPLE_DOC_CHECK_PAGE

ADDRESS_AND_FRAUD_J2:
  nestedJourney: ADDRESS_AND_FRAUD
  exitEvents:
    next:
      targetState: CRI_NINO_J6
      checkIfDisabled:
        hmrcKbv:
          targetState: PRE_EXPERIAN_KBV_TRANSITION_PAGE
    enhanced-verification:
      targetState: CRI_NINO_J6
      checkIfDisabled:
        hmrcKbv:
          targetState: PRE_EXPERIAN_KBV_TRANSITION_PAGE

# Driving licence journey (J3)
CRI_DRIVING_LICENCE_J3:
  response:
    type: cri
    criId: drivingLicence
  parent: CRI_STATE
  events:
    next:
      targetState: ADDRESS_AND_FRAUD_J3
    access-denied:
      targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
      checkIfDisabled:
        f2f:
          targetState: MULTIPLE_DOC_CHECK_PAGE

ADDRESS_AND_FRAUD_J3:
  nestedJourney: ADDRESS_AND_FRAUD
  exitEvents:
    next:
      targetState: CHECK_FRAUD_SCORE_J3
    enhanced-verification:
      targetState: CHECK_FRAUD_SCORE_J3

CHECK_FRAUD_SCORE_J3:
  response:
    type: process
    lambda: check-gpg45-score
    lambdaInput:
      scoreType: fraud
      scoreThreshold: 2
  events:
    met:
      targetState: CRI_NINO_J6
      checkIfDisabled:
        hmrcKbv:
          targetState: PRE_EXPERIAN_KBV_TRANSITION_PAGE
    unmet:
      targetState: PYI_NO_MATCH
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_NO_MATCH

# F2F journey (J4)
CRI_CLAIMED_IDENTITY_J4:
  response:
    type: cri
    criId: claimedIdentity
  parent: CRI_STATE
  events:
    next:
      targetState: ADDRESS_AND_FRAUD_J4
    enhanced-verification:
      targetState: ADDRESS_AND_FRAUD_J4

ADDRESS_AND_FRAUD_J4:
  nestedJourney: ADDRESS_AND_FRAUD
  exitEvents:
    next:
      targetState: CRI_F2F
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_F2F
    enhanced-verification:
      targetState: CRI_F2F
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_F2F

# HMRC KBV journey (J6)
CRI_NINO_J6:
  response:
    type: cri
    criId: nino
  parent: CRI_STATE
  events:
    next:
      targetState: CRI_HMRC_KBV_J6
    fail-with-no-ci:
      targetState: PRE_EXPERIAN_KBV_TRANSITION_PAGE

CRI_HMRC_KBV_J6:
  response:
    type: cri
    criId: hmrcKbv
  parent: CRI_STATE
  events:
    fail-with-no-ci:
      targetState: PRE_EXPERIAN_KBV_TRANSITION_PAGE
    next:
      targetState: EVALUATE_GPG45_SCORES
    enhanced-verification:
      targetState: MITIGATION_02_OPTIONS_WITH_F2F
      checkIfDisabled:
        f2f:
          targetState: MITIGATION_02_OPTIONS

CRI_HMRC_KBV_M2B:
  response:
    type: cri
    criId: hmrcKbv
  parent: CRI_STATE
  events:
    fail-with-no-ci:
      targetState: PRE_EXPERIAN_KBV_TRANSITION_PAGE
    next:
      targetState: EVALUATE_GPG45_SCORES
    enhanced-verification:
      targetState: MITIGATION_02_OPTIONS_WITH_F2F_M2B
      checkIfDisabled:
        f2f:
          targetState: MITIGATION_02_OPTIONS

# No photo id journey (M2B)
CRI_CLAIMED_IDENTITY_M2B:
  response:
    type: cri
    criId: claimedIdentity
    context: bank_account
  parent: CRI_STATE
  events:
    next:
      targetState: CRI_BANK_ACCOUNT_M2B
    enhanced-verification:
      targetState: CRI_BANK_ACCOUNT_M2B

CRI_BANK_ACCOUNT_M2B:
  response:
    type: cri
    criId: bav
  parent: CRI_STATE
  events:
    next:
      targetState: CRI_NINO_WITH_SCOPE_M2B
    fail-with-ci:
      targetState: PYI_NO_MATCH_BAV_M2B

CRI_NINO_WITH_SCOPE_M2B:
  response:
    type: cri
    criId: nino
    scope: identityCheck
  parent: CRI_STATE
  events:
    next:
      targetState: ADDRESS_AND_FRAUD_M2B

ADDRESS_AND_FRAUD_M2B:
  nestedJourney: ADDRESS_AND_FRAUD
  exitEvents:
    next:
      targetState: CRI_HMRC_KBV_M2B
      checkIfDisabled:
        hmrcKbv:
          targetState: PRE_EXPERIAN_KBV_TRANSITION_PAGE_M2B
    enhanced-verification:
      targetState: CRI_HMRC_KBV_M2B
      checkIfDisabled:
        hmrcKbv:
          targetState: PRE_EXPERIAN_KBV_TRANSITION_PAGE_M2B

PRE_EXPERIAN_KBV_TRANSITION_PAGE_M2B:
  response:
    type: page
    pageId: page-pre-experian-kbv-transition
  events:
    next:
      targetState: CRI_EXPERIAN_KBV_M2B

CRI_EXPERIAN_KBV_M2B:
  response:
    type: cri
    criId: kbv
  parent: CRI_STATE
  events:
    fail-with-no-ci:
      targetState: PYI_KBV_DROPOUT_M2B
      checkIfDisabled:
        f2f:
          targetState: PYI_CRI_ESCAPE_NO_F2F
    next:
      targetState: PYI_NO_MATCH
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_NO_MATCH
    enhanced-verification:
      targetState: MITIGATION_KBV_FAIL_M2B
      checkIfDisabled:
        f2f:
          targetState: MITIGATION_02_OPTIONS

PYI_NO_MATCH_BAV_M2B:
  response:
    type: page
    context: bankAccount
    pageId: pyi-no-match
  parent: END_JOURNEY

MITIGATION_KBV_FAIL_M2B:
  response:
    mitigationStart: true
    type: page
    pageId: pyi-kbv-escape-m2b
  events:
    f2f:
      targetState: CRI_F2F
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_F2F
    dcmaw:
      targetState: CRI_DCMAW_PYI_ESCAPE
    end:
      targetState: PYI_ANOTHER_WAY
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_ANOTHER_WAY

PYI_KBV_DROPOUT_M2B:
  response:
    type: page
    pageId: pyi-kbv-escape-m2b
    context: dropout
  events:
    f2f:
      targetState: CRI_F2F
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_F2F
    dcmaw:
      targetState: CRI_DCMAW_PYI_ESCAPE
    end:
      targetState: PYI_ANOTHER_WAY
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_ANOTHER_WAY

# Mitigation journey (01)
MITIGATION_01:
  response:
    type: process
    lambda: reset-identity
    lambdaInput:
      isUserInitiated: false
      deleteOnlyGPG45VCs: true
    mitigationStart: true
  events:
    next:
      targetState: MITIGATION_01_IDENTITY_START_PAGE

MITIGATION_01_IDENTITY_START_PAGE:
  response:
    type: page
    pageId: page-ipv-identity-document-start
  events:
    next:
      targetState: MITIGATION_01_CRI_DCMAW
    end:
      targetState: MITIGATION_01_F2F_START_PAGE
      checkIfDisabled:
        f2f:
          targetState: PYI_ANOTHER_WAY
          checkFeatureFlag:
            ticfCriBeta:
              targetState: CRI_TICF_BEFORE_ANOTHER_WAY

MITIGATION_01_CRI_DCMAW:
  response:
    type: cri
    criId: dcmaw
  parent: CRI_STATE
  events:
    next:
      targetState: POST_DCMAW_SUCCESS_PAGE
    not-found:
      targetState: PYI_NO_MATCH
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_NO_MATCH
    access-denied:
      targetState: MITIGATION_01_PYI_POST_OFFICE
      checkIfDisabled:
        f2f:
          targetState: PYI_ANOTHER_WAY
          checkFeatureFlag:
            ticfCriBeta:
              targetState: CRI_TICF_BEFORE_ANOTHER_WAY
    temporarily-unavailable:
      targetState: MITIGATION_01_PYI_POST_OFFICE
      checkIfDisabled:
        f2f:
          targetState: PYI_ANOTHER_WAY
          checkFeatureFlag:
            ticfCriBeta:
              targetState: CRI_TICF_BEFORE_ANOTHER_WAY
    fail-with-no-ci:
      targetState: MITIGATION_01_PYI_POST_OFFICE
      checkIfDisabled:
        f2f:
          targetState: PYI_ANOTHER_WAY
          checkFeatureFlag:
            ticfCriBeta:
              targetState: CRI_TICF_BEFORE_ANOTHER_WAY
    enhanced-verification:
      targetState: MITIGATION_01_PYI_POST_OFFICE
      checkIfDisabled:
        f2f:
          targetState: PYI_ANOTHER_WAY
          checkFeatureFlag:
            ticfCriBeta:
              targetState: CRI_TICF_BEFORE_ANOTHER_WAY

MITIGATION_01_F2F_START_PAGE:
  response:
    type: page
    pageId: page-ipv-identity-postoffice-start
  events:
    next:
      targetState: CRI_CLAIMED_IDENTITY_J4
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_CLAIMED_IDENTITY_J4
    end:
      targetState: PYI_ANOTHER_WAY
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_ANOTHER_WAY

MITIGATION_01_PYI_POST_OFFICE:
  response:
    type: page
    pageId: pyi-post-office
  events:
    next:
      targetState: CRI_CLAIMED_IDENTITY_J4
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_CLAIMED_IDENTITY_J4
    end:
      targetState: PYI_ANOTHER_WAY
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_ANOTHER_WAY

# Mitigation journey (02)
MITIGATION_02_OPTIONS:
  response:
    type: page
    pageId: pyi-suggest-other-options-no-f2f
    mitigationStart: true
  events:
    next:
      targetState: CRI_DCMAW_PYI_ESCAPE
    end:
      targetState: PYI_ANOTHER_WAY
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_ANOTHER_WAY

CRI_DCMAW_PYI_ESCAPE:
  response:
    type: cri
    criId: dcmaw
  parent: CRI_STATE
  events:
    next:
      targetState: EVALUATE_GPG45_SCORES
    not-found:
      targetState: PYI_POST_OFFICE
      checkIfDisabled:
        f2f:
          targetState: PYI_NO_MATCH
          checkFeatureFlag:
            ticfCriBeta:
              targetState: CRI_TICF_BEFORE_NO_MATCH
    access-denied:
      targetState: PYI_POST_OFFICE
      checkIfDisabled:
        f2f:
          targetState: PYI_ANOTHER_WAY
          checkFeatureFlag:
            ticfCriBeta:
              targetState: CRI_TICF_BEFORE_ANOTHER_WAY
    temporarily-unavailable:
      targetState: PYI_POST_OFFICE
      checkIfDisabled:
        f2f:
          targetState: PYI_ANOTHER_WAY
          checkFeatureFlag:
            ticfCriBeta:
              targetState: CRI_TICF_BEFORE_ANOTHER_WAY
    fail-with-no-ci:
      targetState: PYI_POST_OFFICE
      checkIfDisabled:
        f2f:
          targetState: PYI_ANOTHER_WAY
          checkFeatureFlag:
            ticfCriBeta:
              targetState: CRI_TICF_BEFORE_ANOTHER_WAY
    enhanced-verification:
      targetState: PYI_POST_OFFICE
      checkIfDisabled:
        f2f:
          targetState: PYI_ANOTHER_WAY
          checkFeatureFlag:
            ticfCriBeta:
              targetState: CRI_TICF_BEFORE_ANOTHER_WAY

MITIGATION_02_OPTIONS_WITH_F2F:
  response:
    type: page
    pageId: pyi-suggest-other-options
    mitigationStart: true
  events:
    f2f:
      targetState: CRI_F2F
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_F2F
    dcmaw:
      targetState: CRI_DCMAW_PYI_ESCAPE
    end:
      targetState: PYI_ANOTHER_WAY
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_ANOTHER_WAY

MITIGATION_02_OPTIONS_WITH_F2F_M2B:
  response:
    type: page
    pageId: pyi-suggest-other-options
    context: no-photo-id
    mitigationStart: true
  events:
    f2f:
      targetState: CRI_F2F
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_F2F
    dcmaw:
      targetState: CRI_DCMAW_PYI_ESCAPE
    end:
      targetState: PYI_ANOTHER_WAY
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_ANOTHER_WAY

PYI_POST_OFFICE:
  response:
    type: page
    pageId: pyi-post-office
  events:
    next:
      targetState: CRI_F2F
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_F2F
    end:
      targetState: PYI_ANOTHER_WAY
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_ANOTHER_WAY
