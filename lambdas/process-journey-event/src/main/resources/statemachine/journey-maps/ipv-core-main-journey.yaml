# parent states
END_JOURNEY:
  events:
    next:
      targetState: END

CRI_STATE:
  events:
    next:
      targetState: ERROR
    not-found:
      targetState: ERROR
    fail-with-no-ci:
      targetState: ERROR
    error:
      targetState: ERROR
    access-denied:
      targetState: PYI_NO_MATCH
    enhanced-verification:
      targetState: ERROR
    temporarily-unavailable:
      targetState: PYI_NO_MATCH
    end:
      targetState: IPV_SUCCESS_PAGE
    pyi-no-match:
      targetState: PYI_NO_MATCH
    pyi-kbv-fail:
      targetState: PYI_KBV_FAIL

# Shared states
INITIAL_IPV_JOURNEY:
  events:
    next:
      targetState: INITIAL_CI_SCORING

F2F_START_PAGE:
  response:
    type: page
    pageId: page-ipv-identity-postoffice-start
  events:
    next:
      targetState: CRI_CLAIMED_IDENTITY_J4
    end:
      targetState: PYI_ESCAPE

F2F_PYI_POST_OFFICE:
  response:
    type: page
    pageId: pyi-post-office
  events:
    next:
      targetState: CRI_CLAIMED_IDENTITY_J4
    end:
      targetState: PYI_ESCAPE

INITIAL_CI_SCORING:
  response:
    type: process
    lambda: ci-scoring
  events:
    ci-score-not-breaching:
      targetState: CHECK_EXISTING_IDENTITY
    reuse:
      targetState: IPV_IDENTITY_REUSE_PAGE
    pending:
      targetState: IPV_IDENTITY_PENDING_PAGE
    pyi-no-match:
      targetState: PYI_NO_MATCH
    pyi-kbv-fail:
      targetState: PYI_KBV_FAIL
    fail:
      targetState: PYI_F2F_TECHNICAL
    error:
      targetState: ERROR
    enhanced-verification:
      targetState: MITIGATION_01

CHECK_EXISTING_IDENTITY:
  response:
    type: process
    lambda: check-existing-identity
  events:
    next:
      targetState: IPV_IDENTITY_START_PAGE
    reset-identity:
      targetState: RESET_IDENTITY
    reuse:
      targetState: IPV_IDENTITY_REUSE_PAGE
    pending:
      targetState: IPV_IDENTITY_PENDING_PAGE
    pyi-no-match:
      targetState: PYI_NO_MATCH
    pyi-kbv-fail:
      targetState: PYI_KBV_FAIL
    fail:
      targetState: PYI_F2F_TECHNICAL
    error:
      targetState: ERROR

RESET_IDENTITY:
  response:
    type: process
    lambda: reset-identity
  events:
    next:
      targetState: IPV_IDENTITY_START_PAGE

IPV_IDENTITY_REUSE_PAGE:
  response:
    type: page
    pageId: page-ipv-reuse
  parent: END_JOURNEY

IPV_IDENTITY_PENDING_PAGE:
  response:
    type: page
    pageId: page-ipv-pending

IPV_IDENTITY_START_PAGE:
  response:
    type: page
    pageId: page-ipv-identity-document-start
  events:
    next:
      targetState: CRI_DCMAW
      checkIfDisabled:
        dcmaw:
          targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
          checkIfDisabled:
            f2f:
              targetState: MULTIPLE_DOC_CHECK_PAGE
    end:
      targetState: F2F_START_PAGE
      checkIfDisabled:
        f2f:
          targetState: PYI_ANOTHER_WAY

CRI_F2F:
  response:
    type: cri
    criId: f2f
  parent: CRI_STATE
  events:
    next:
      targetState: F2F_HANDOFF_PAGE
    access-denied:
      targetState: PYI_ANOTHER_WAY
    enhanced-verification:
      targetState: F2F_HANDOFF_PAGE

F2F_HANDOFF_PAGE:
  response:
    type: page
    pageId: page-face-to-face-handoff

PYI_ANOTHER_WAY:
  response:
    type: page
    pageId: pyi-another-way
  parent: END_JOURNEY

CRI_DCMAW:
  response:
    type: cri
    criId: dcmaw
  parent: CRI_STATE
  events:
    next:
      targetState: POST_DCMAW_SUCCESS_PAGE
    not-found:
      targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
      checkIfDisabled:
        f2f:
          targetState: MULTIPLE_DOC_CHECK_PAGE
    access-denied:
      targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
      checkIfDisabled:
        f2f:
          targetState: MULTIPLE_DOC_CHECK_PAGE
    temporarily-unavailable:
      targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
      checkIfDisabled:
        f2f:
          targetState: MULTIPLE_DOC_CHECK_PAGE
    fail-with-no-ci:
      targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
      checkIfDisabled:
        f2f:
          targetState: MULTIPLE_DOC_CHECK_PAGE

MULTIPLE_DOC_CHECK_PAGE:
  response:
    type: page
    pageId: page-multiple-doc-check
  events:
    ukPassport:
      targetState: CRI_UK_PASSPORT_J2
    drivingLicence:
      targetState: CRI_DRIVING_LICENCE_J3
    end:
      targetState: END

MULTIPLE_DOC_F2F_CHECK_PAGE:
  response:
    type: page
    pageId: page-f2f-multiple-doc-check
  events:
    ukPassport:
      targetState: CRI_UK_PASSPORT_J2
    drivingLicence:
      targetState: CRI_DRIVING_LICENCE_J3
    end:
      targetState: F2F_PYI_POST_OFFICE

PYI_NO_MATCH:
  response:
    type: page
    pageId: pyi-no-match
  parent: END_JOURNEY

PYI_KBV_FAIL:
  response:
    type: page
    pageId: pyi-kbv-fail
  parent: END_JOURNEY

PYI_KBV_THIN_FILE:
  response:
    type: page
    pageId: pyi-kbv-thin-file
  parent: END_JOURNEY

PYI_F2F_TECHNICAL:
  response:
    type: page
    pageId: pyi-f2f-technical
  events:
    next:
      targetState: RESET_IDENTITY
    end:
      targetState: END

PYI_ESCAPE:
  response:
    type: page
    pageId: pyi-escape
  events:
    next:
      targetState: RESET_IDENTITY
    end:
      targetState: END

PYI_CRI_ESCAPE:
  response:
    type: page
    pageId: pyi-cri-escape
  events:
    dcmaw:
      targetState: CRI_DCMAW_J5
    f2f:
      targetState: CRI_F2F
    end:
      targetState: END

PYI_CRI_ESCAPE_NO_F2F:
  response:
    type: page
    pageId: pyi-cri-escape-no-f2f
  events:
    next:
      targetState: CRI_DCMAW_J5
    end:
      targetState: END

ERROR:
  response:
    type: error
    pageId: pyi-technical
    statusCode: 500
  parent: END_JOURNEY

CORE_SESSION_TIMEOUT:
  response:
    type: page
    pageId: pyi-timeout-unrecoverable
  parent: END_JOURNEY

IPV_SUCCESS_PAGE:
  response:
    type: page
    pageId: page-ipv-success
  parent: END_JOURNEY

END:
  response:
    type: process
    lambda: build-client-oauth-response

# DCMAW journey (J1)
POST_DCMAW_SUCCESS_PAGE:
  response:
    type: page
    pageId: page-dcmaw-success
  events:
    next:
      targetState: ADDRESS_AND_FRAUD_J1

ADDRESS_AND_FRAUD_J1:
  nestedJourney: ADDRESS_AND_FRAUD
  exitEvents:
    end:
      targetState: IPV_SUCCESS_PAGE
    next:
      targetState: PYI_NO_MATCH

# Passport journey (J2)
CRI_UK_PASSPORT_J2:
  response:
    type: cri
    criId: ukPassport
  parent: CRI_STATE
  events:
    next:
      targetState: ADDRESS_AND_FRAUD_J2
    access-denied:
      targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
      checkIfDisabled:
        f2f:
          targetState: MULTIPLE_DOC_CHECK_PAGE

ADDRESS_AND_FRAUD_J2:
  nestedJourney: ADDRESS_AND_FRAUD
  exitEvents:
    next:
      targetState: CRI_NINO_J6
      checkIfDisabled:
        hmrcKbv:
          targetState: PRE_KBV_TRANSITION_PAGE_J2
    end:
      targetState: ERROR

PRE_KBV_TRANSITION_PAGE_J2:
  response:
    type: page
    pageId: page-pre-kbv-transition
  events:
    next:
      targetState: CRI_KBV_J2

CRI_KBV_J2:
  response:
    type: cri
    criId: kbv
  parent: CRI_STATE
  events:
    end:
      targetState: IPV_SUCCESS_PAGE
    fail-with-no-ci:
      targetState: PYI_CRI_ESCAPE
      checkIfDisabled:
        f2f:
          targetState: PYI_CRI_ESCAPE_NO_F2F
    enhanced-verification:
      targetState: MITIGATION_02_OPTIONS

# Driving licence journey (J3)
CRI_DRIVING_LICENCE_J3:
  response:
    type: cri
    criId: drivingLicence
  parent: CRI_STATE
  events:
    next:
      targetState: ADDRESS_AND_FRAUD_J3
    access-denied:
      targetState: MULTIPLE_DOC_F2F_CHECK_PAGE
      checkIfDisabled:
        f2f:
          targetState: MULTIPLE_DOC_CHECK_PAGE

ADDRESS_AND_FRAUD_J3:
  nestedJourney: ADDRESS_AND_FRAUD
  exitEvents:
    next:
      targetState: CHECK_FRAUD_SCORE_J3
    end:
      targetState: ERROR

CHECK_FRAUD_SCORE_J3:
  response:
    type: process
    lambda: check-gpg45-score
    lambdaInput:
      scoreType: fraud
      scoreThreshold: 2
  events:
    met:
      targetState: PRE_KBV_TRANSITION_PAGE_J3
    unmet:
      targetState: PYI_NO_MATCH

PRE_KBV_TRANSITION_PAGE_J3:
  response:
    type: page
    pageId: page-pre-kbv-transition
  events:
    next:
      targetState: CRI_KBV_J3

CRI_KBV_J3:
  response:
    type: cri
    criId: kbv
  parent: CRI_STATE
  events:
    end:
      targetState: IPV_SUCCESS_PAGE
    fail-with-no-ci:
      targetState: PYI_CRI_ESCAPE
      checkIfDisabled:
        f2f:
          targetState: PYI_CRI_ESCAPE_NO_F2F
    next:
      targetState: PYI_NO_MATCH
    enhanced-verification:
      targetState: MITIGATION_02_OPTIONS

# F2F journey (J4)
CRI_CLAIMED_IDENTITY_J4:
  response:
    type: cri
    criId: claimedIdentity
  parent: CRI_STATE
  events:
    next:
      targetState: ADDRESS_AND_FRAUD_J4
    enhanced-verification:
      targetState: ADDRESS_AND_FRAUD_J4

ADDRESS_AND_FRAUD_J4:
  nestedJourney: ADDRESS_AND_FRAUD
  exitEvents:
    next:
      targetState: CRI_F2F
    end:
      targetState: ERROR

# CRI escape journey (J5)
CRI_DCMAW_J5:
  response:
    type: cri
    criId: dcmaw
  parent: CRI_STATE
  events:
    next:
      targetState: POST_DCMAW_SUCCESS_PAGE_J5
    not-found:
      targetState: PYI_ANOTHER_WAY
    fail-with-no-ci:
      targetState: PYI_ANOTHER_WAY

POST_DCMAW_SUCCESS_PAGE_J5:
  response:
    type: page
    pageId: page-dcmaw-success
  events:
    next:
      targetState: IPV_SUCCESS_PAGE

# HMRC KBV journey (J6)
CRI_NINO_J6:
  response:
    type: cri
    criId: nino
  parent: CRI_STATE
  events:
    next:
      targetState: CRI_HMRC_KBV_J6
    fail-with-no-ci:
      targetState: PRE_KBV_TRANSITION_PAGE_J2

CRI_HMRC_KBV_J6:
  response:
    type: cri
    criId: hmrcKbv
  parent: CRI_STATE
  events:
    end:
      targetState: IPV_SUCCESS_PAGE
    fail-with-no-ci:
      targetState: PRE_KBV_TRANSITION_PAGE_J3
    next:
      targetState: PYI_NO_MATCH

# Mitigation journey (01)
MITIGATION_01:
  response:
    type: process
    lambda: reset-identity
  events:
    next:
      targetState: MITIGATION_01_IDENTITY_START_PAGE

MITIGATION_01_IDENTITY_START_PAGE:
  response:
    type: page
    pageId: page-ipv-identity-document-start
  events:
    next:
      targetState: MITIGATION_01_CRI_DCMAW
    end:
      targetState: PYI_ANOTHER_WAY
      checkFeatureFlag:
        f2fCimit:
          targetState: MITIGATION_01_F2F_START_PAGE
          checkIfDisabled:
            f2f:
              targetState: PYI_ANOTHER_WAY

MITIGATION_01_CRI_DCMAW:
  response:
    type: cri
    criId: dcmaw
  parent: CRI_STATE
  events:
    next:
      targetState: POST_DCMAW_SUCCESS_PAGE
    not-found:
      targetState: PYI_NO_MATCH
      checkFeatureFlag:
        f2fCimit:
          targetState: MITIGATION_01_SUGGEST_F2F
          checkIfDisabled:
            f2f:
              targetState: PYI_NO_MATCH
    access-denied:
      targetState: PYI_ANOTHER_WAY
      checkFeatureFlag:
        f2fCimit:
          targetState: MITIGATION_01_SUGGEST_F2F
          checkIfDisabled:
            f2f:
              targetState: PYI_ANOTHER_WAY
    temporarily-unavailable:
      targetState: PYI_ANOTHER_WAY
      checkFeatureFlag:
        f2fCimit:
          targetState: MITIGATION_01_SUGGEST_F2F
          checkIfDisabled:
            f2f:
              targetState: PYI_ANOTHER_WAY
    fail-with-no-ci:
      targetState: PYI_ANOTHER_WAY
      checkFeatureFlag:
        f2fCimit:
          targetState: MITIGATION_01_SUGGEST_F2F
          checkIfDisabled:
            f2f:
              targetState: PYI_ANOTHER_WAY
    enhanced-verification:
      targetState: PYI_ANOTHER_WAY
      checkFeatureFlag:
        f2fCimit:
          targetState: MITIGATION_01_SUGGEST_F2F
          checkIfDisabled:
            f2f:
              targetState: PYI_ANOTHER_WAY

MITIGATION_01_F2F_START_PAGE:
  response:
    type: page
    pageId: page-ipv-identity-postoffice-start
  events:
    next:
      targetState: CRI_CLAIMED_IDENTITY_J4
    end:
      targetState: PYI_ANOTHER_WAY

MITIGATION_01_SUGGEST_F2F:
  response:
    type: page
    pageId: pyi-suggest-f2f
  events:
    next:
      targetState: MITIGATION_01_F2F_START_PAGE

# Mitigation journey (02)
MITIGATION_02_OPTIONS:
  response:
    type: page
    pageId: pyi-suggest-other-options-no-f2f
  events:
    next:
      targetState: MITIGATION_02_CRI_ELIGIBILITY
    end:
      targetState: PYI_ANOTHER_WAY

MITIGATION_02_CRI_ELIGIBILITY:
  response:
    type: page
    pageId: page-ipv-identity-document-start
  events:
    next:
      targetState: MITIGATION_02_CRI_DCMAW
    end:
      targetState: PYI_ANOTHER_WAY

MITIGATION_02_CRI_DCMAW:
  response:
    type: cri
    criId: dcmaw
  parent: CRI_STATE
  events:
    not-found:
      targetState: PYI_NO_MATCH
    access-denied:
      targetState: PYI_ANOTHER_WAY
    temporarily-unavailable:
      targetState: PYI_ANOTHER_WAY
    fail-with-no-ci:
      targetState: PYI_ANOTHER_WAY
    enhanced-verification:
      targetState: PYI_ANOTHER_WAY
