ADDRESS_AND_FRAUD:
  name: Address and Fraud
  description: >-
    The combined journey for Address and Fraud CRIs.
  entryEvents:
    next:
      targetState: CRI_ADDRESS
    enhanced-verification:
      targetState: CRI_ADDRESS
  nestedJourneyStates:
    CRI_ADDRESS:
      response:
        type: cri
        criId: address
      parent: CRI_STATE
      events:
        next:
          targetState: CRI_FRAUD
        enhanced-verification:
          targetState: CRI_FRAUD
    CRI_FRAUD:
      response:
        type: cri
        criId: fraud
      parent: CRI_STATE
      events:
        next:
          exitEventToEmit: next
        enhanced-verification:
          exitEventToEmit: enhanced-verification

STRATEGIC_APP_TRIAGE:
  name: Strategic App Triage
  description: >-
    App triage pages to determine eligibility for the app
    and handover to the appropriate journey type.
  entryEvents:
    appTriage:
      targetState: SELECT_DEVICE_PAGE
    appTriageSmartphone:
      targetState: MAM_SELECT_SMARTPHONE
    appTriageSmartphoneIphone:
      targetState: MOBILE_IPHONE_CONFIRM_PAGE
    appTriageSmartphoneAndroid:
      targetState: MOBILE_ANDROID_CONFIRM_PAGE

  nestedJourneyStates:
    SELECT_DEVICE_PAGE:
      response:
        type: page
        pageId: pyi-triage-select-device
      events:
        computer-or-tablet:
          targetState: DAD_SELECT_SMARTPHONE
        smartphone:
          targetState: MAM_SELECT_SMARTPHONE

    DAD_SELECT_SMARTPHONE:
      response:
        type: page
        pageId: pyi-triage-select-smartphone
      events:
        iphone:
          targetState: DAD_IPHONE_START_SESSION
        android:
          targetState: DAD_ANDROID_START_SESSION
        end:
          exitEventToEmit: end

    DAD_IPHONE_START_SESSION:
      response:
        type: process
        lambda: call-dcmaw-async-cri
      events:
        next:
          targetState: DESKTOP_IPHONE_DOWNLOAD_PAGE
        error:
          exitEventToEmit: multipleDocCheckPage

    DAD_ANDROID_START_SESSION:
      response:
        type: process
        lambda: call-dcmaw-async-cri
      events:
        next:
          targetState: DESKTOP_ANDROID_DOWNLOAD_PAGE
        error:
          exitEventToEmit: multipleDocCheckPage

    DESKTOP_IPHONE_DOWNLOAD_PAGE:
      response:
        type: page
        pageId: pyi-triage-desktop-download-app
        context: iphone

    DESKTOP_ANDROID_DOWNLOAD_PAGE:
      response:
        type: page
        pageId: pyi-triage-desktop-download-app
        context: android

    MAM_SELECT_SMARTPHONE:
      response:
        type: page
        pageId: pyi-triage-select-smartphone
      events:
        iphone:
          targetState: MOBILE_IPHONE_START_SESSION
        android:
          targetState: MOBILE_ANDROID_START_SESSION
        end:
          exitEventToEmit: end

    MOBILE_IPHONE_CONFIRM_PAGE:
      response:
        type: page
        pageId: pyi-triage-mobile-confirm
      events:
        next:
          targetState: MOBILE_IPHONE_START_SESSION
        end:
          exitEventToEmit: end

    MOBILE_ANDROID_CONFIRM_PAGE:
      response:
        type: page
        pageId: pyi-triage-mobile-confirm
      events:
        next:
          targetState: MOBILE_ANDROID_START_SESSION
        end:
          exitEventToEmit: end

    MOBILE_IPHONE_START_SESSION:
      response:
        type: process
        lambda: call-dcmaw-async-cri
      events:
        next:
          targetState: MOBILE_IPHONE_DOWNLOAD_PAGE
        error:
          exitEventToEmit: multipleDocCheckPage

    MOBILE_ANDROID_START_SESSION:
      response:
        type: process
        lambda: call-dcmaw-async-cri
      events:
        next:
          targetState: MOBILE_ANDROID_DOWNLOAD_PAGE
        error:
          exitEventToEmit: multipleDocCheckPage

    MOBILE_IPHONE_DOWNLOAD_PAGE:
      response:
        type: page
        pageId: pyi-triage-mobile-download-app
        context: iphone
      events:
        next:
          exitEventToEmit: next

    MOBILE_ANDROID_DOWNLOAD_PAGE:
      response:
        type: page
        pageId: pyi-triage-mobile-download-app
        context: android
      events:
        next:
          exitEventToEmit: next

WEB_DL_OR_PASSPORT:
  name: Web Driving Licence or Passport
  description: >-
    The combined journey for web Driving Licence and Passport CRIs.
  entryEvents:
    ukPassport:
      targetState: CRI_UK_PASSPORT
    drivingLicence:
      targetState: CRI_DRIVING_LICENCE
    alternate-doc-invalid-dl:
      targetState: MITIGATION_DL_NO_MATCH
    alternate-doc-invalid-passport:
      targetState: MITIGATION_PP_NO_MATCH
  nestedJourneyStates:
    CRI_UK_PASSPORT:
      response:
        type: cri
        criId: ukPassport
      parent: CRI_STATE
      events:
        next:
          targetState: ADDRESS_AND_FRAUD_AFTER_PASSPORT
        access-denied:
          targetState: PROVE_ANOTHER_WAY_AFTER_PASSPORT
          checkIfDisabled:
            f2f:
              targetState: MULTIPLE_DOC_CHECK_PAGE
        alternate-doc-invalid-passport:
          targetState: MITIGATION_PP_NO_MATCH_ANOTHER_WAY
          auditEvents:
            - IPV_MITIGATION_START
          auditContext:
            mitigationType: invalid-passport
    ADDRESS_AND_FRAUD_AFTER_PASSPORT:
      nestedJourney: ADDRESS_AND_FRAUD
      exitEvents:
        next:
          exitEventToEmit: next-passport
        enhanced-verification:
          exitEventToEmit: next-passport
    PROVE_ANOTHER_WAY_AFTER_PASSPORT:
      response:
        type: page
        pageId: prove-identity-another-type-photo-id
        context: passport
      events:
        otherPhotoId:
          targetState: CRI_DRIVING_LICENCE
        f2f:
          exitEventToEmit: end
        returnToRp:
          exitEventToEmit: return-to-rp
    CRI_DRIVING_LICENCE:
      response:
        type: cri
        criId: drivingLicence
      parent: CRI_STATE
      events:
        next:
          targetState: ADDRESS_AND_FRAUD_AFTER_DL
        access-denied:
          targetState: PROVE_ANOTHER_WAY_AFTER_DL
          checkIfDisabled:
            f2f:
              targetState: MULTIPLE_DOC_CHECK_PAGE
        alternate-doc-invalid-dl:
          targetState: MITIGATION_DL_NO_MATCH_ANOTHER_WAY
          auditEvents:
            - IPV_MITIGATION_START
          auditContext:
            mitigationType: invalid-dl
    ADDRESS_AND_FRAUD_AFTER_DL:
      nestedJourney: ADDRESS_AND_FRAUD
      exitEvents:
        next:
          exitEventToEmit: next-dl
        enhanced-verification:
          exitEventToEmit: next-dl
    PROVE_ANOTHER_WAY_AFTER_DL:
      response:
        type: page
        pageId: prove-identity-another-type-photo-id
        context: drivingLicence
      events:
        otherPhotoId:
          targetState: CRI_UK_PASSPORT
        f2f:
          exitEventToEmit: end
        returnToRp:
          exitEventToEmit: return-to-rp

    # Invalid passport mitigation routes
    MITIGATION_PP_NO_MATCH:
      response:
        type: page
        pageId: pyi-passport-no-match
      events:
        next:
          targetState: MITIGATION_DL_START
          auditEvents:
            - IPV_MITIGATION_START
          auditContext:
            mitigationType: invalid-passport
    MITIGATION_DL_START:
      response:
        type: page
        pageId: pyi-continue-with-driving-licence
      events:
        next:
          targetState: MITIGATION_DL_CRI_DRIVING_LICENCE
        end:
          exitEventToEmit: return-to-rp
    MITIGATION_PP_NO_MATCH_ANOTHER_WAY:
      response:
        type: page
        pageId: pyi-passport-no-match-another-way
      events:
        next:
          targetState: MITIGATION_DL_CRI_DRIVING_LICENCE
        end:
          exitEventToEmit: return-to-rp
    MITIGATION_DL_CRI_DRIVING_LICENCE:
      response:
        type: cri
        criId: drivingLicence
      parent: CRI_STATE
      events:
        next:
          targetState: MITIGATION_DL_ADDRESS_AND_FRAUD
        access-denied:
          targetState: MITIGATION_DL_PROVE_ANOTHER_WAY
    MITIGATION_DL_PROVE_ANOTHER_WAY:
      response:
        type: page
        pageId: prove-identity-no-other-photo-id
        context: drivingLicence
      events:
        back:
          targetState: MITIGATION_DL_CRI_DRIVING_LICENCE
        returnToRp:
          exitEventToEmit: return-to-rp
    MITIGATION_DL_ADDRESS_AND_FRAUD:
      nestedJourney: ADDRESS_AND_FRAUD
      exitEvents:
        next:
          exitEventToEmit: alternate-doc-next-dl
        enhanced-verification:
          exitEventToEmit: failed

    # Invalid DL mitigation routes
    MITIGATION_DL_NO_MATCH:
      response:
        type: page
        pageId: pyi-driving-licence-no-match
      events:
        next:
          targetState: MITIGATION_PP_START
          auditEvents:
            - IPV_MITIGATION_START
          auditContext:
            mitigationType: invalid-dl
    MITIGATION_PP_START:
      response:
        type: page
        pageId: pyi-continue-with-passport
      events:
        next:
          targetState: MITIGATION_PP_CRI_UK_PASSPORT
        end:
          exitEventToEmit: return-to-rp
    MITIGATION_DL_NO_MATCH_ANOTHER_WAY:
      response:
        type: page
        pageId: pyi-driving-licence-no-match-another-way
      events:
        next:
          targetState: MITIGATION_PP_CRI_UK_PASSPORT
        end:
          exitEventToEmit: return-to-rp
    MITIGATION_PP_CRI_UK_PASSPORT:
      response:
        type: cri
        criId: ukPassport
      parent: CRI_STATE
      events:
        next:
          targetState: MITIGATION_PP_ADDRESS_AND_FRAUD
        access-denied:
          targetState: MITIGATION_PP_PROVE_ANOTHER_WAY
    MITIGATION_PP_ADDRESS_AND_FRAUD:
      nestedJourney: ADDRESS_AND_FRAUD
      exitEvents:
        next:
          exitEventToEmit: alternate-doc-next-passport
        enhanced-verification:
          exitEventToEmit: failed
    MITIGATION_PP_PROVE_ANOTHER_WAY:
      response:
        type: page
        pageId: prove-identity-no-other-photo-id
        context: passport
      events:
        back:
          targetState: MITIGATION_PP_CRI_UK_PASSPORT
        returnToRp:
          exitEventToEmit: return-to-rp

KBVS:
  name: KBV challenge routing
  description: >-
    The combined journey for enabled KBV CRIs.

    When redirecting to a KBV CRI, IPV Core will request a verification score
    corresponding to the target Vector of Trust (P1 or P2).
  entryEvents:
    next:
      targetState: CRI_DWP_KBV
      checkIfDisabled:
        dwpKbv:
          targetState: CRI_NINO
          checkIfDisabled:
            hmrcKbv:
              targetState: PRE_EXPERIAN_PAGE
    next-with-nino:
      targetState: CRI_DWP_KBV
      checkIfDisabled:
        dwpKbv:
          targetState: CRI_HMRC_KBV
          checkIfDisabled:
            hmrcKbv:
              targetState: PRE_EXPERIAN_PAGE
  nestedJourneyStates:
    CRI_NINO:
      response:
        type: cri
        criId: nino
      parent: CRI_STATE
      events:
        next:
          targetState: CRI_HMRC_KBV
        fail-with-no-ci:
          targetState: PRE_EXPERIAN_PAGE
    CRI_DWP_KBV:
      response:
        type: cri
        criId: dwpKbv
      parent: CRI_STATE
      events:
        next:
          exitEventToEmit: next
        enhanced-verification:
          exitEventToEmit: enhanced-verification
        invalid-request:
          targetState: PRE_EXPERIAN_PAGE
        access-denied:
          targetState: PRE_EXPERIAN_PAGE
    CRI_HMRC_KBV:
      response:
        type: cri
        criId: hmrcKbv
      parent: CRI_STATE
      events:
        next:
          exitEventToEmit: next
        enhanced-verification:
          exitEventToEmit: enhanced-verification
        invalid-request:
          targetState: PRE_EXPERIAN_PAGE
        access-denied:
          targetState: PRE_EXPERIAN_PAGE
    PRE_EXPERIAN_PAGE:
      response:
        type: page
        pageId: page-pre-experian-kbv-transition
      events:
        next:
          targetState: CRI_EXPERIAN_KBV
    CRI_EXPERIAN_KBV:
      response:
        type: cri
        criId: kbv
      parent: CRI_STATE
      events:
        fail-with-no-ci:
          exitEventToEmit: fail-with-no-ci
        next:
          exitEventToEmit: next
        enhanced-verification:
          exitEventToEmit: enhanced-verification
