# Entry points

START:
  events:
    next:
      targetState: IDENTITY_REUSE_PAGE
      checkFeatureFlag:
        ticfCriBeta:
          targetState: CRI_TICF_BEFORE_REUSE
        deleteDetailsEnabled:
          targetState: IDENTITY_REUSE_PAGE_TEST

# Journey states

CRI_TICF_BEFORE_REUSE:
  response:
    type: process
    lambda: call-ticf-cri
  events:
    next:
      targetState: IDENTITY_REUSE_PAGE
      checkFeatureFlag:
        deleteDetailsEnabled:
          targetState: IDENTITY_REUSE_PAGE_TEST
    enhanced-verification:
      targetJourney: FAILED
      targetState: FAILED_NO_TICF
    alternate-doc-invalid-dl:
      targetJourney: FAILED
      targetState: FAILED_NO_TICF
    alternate-doc-invalid-passport:
      targetJourney: FAILED
      targetState: FAILED_NO_TICF
    fail-with-ci:
      targetJourney: FAILED
      targetState: FAILED_NO_TICF
    error:
      targetJourney: TECHNICAL_ERROR
      targetState: ERROR_NO_TICF

IDENTITY_REUSE_PAGE:
  response:
    type: page
    pageId: page-ipv-reuse
  events:
    next:
      targetState: RETURN_TO_RP
    update-details:
      targetState: UPDATE_DETAILS_PAGE

IDENTITY_REUSE_PAGE_TEST:
  response:
    type: page
    pageId: page-ipv-reuse
  events:
    next:
      targetState: NEW_DETAILS_PAGE
    update-details:
      targetState: UPDATE_DETAILS_PAGE

NEW_DETAILS_PAGE:
  response:
    type: page
    pageId: pyi-new-details
  events:
    next:
      targetState: CONFIRM_DELETE_DETAILS_PAGE
    end:
      targetState: IDENTITY_REUSE_PAGE

CONFIRM_DELETE_DETAILS_PAGE:
  response:
    type: page
    pageId: pyi-confirm-delete-details
  events:
    next:
      targetState: RESET_SESSION_IDENTITY
    end:
      targetState: IDENTITY_REUSE_PAGE

RESET_SESSION_IDENTITY:
  response:
    type: process
    lambda: reset-session-identity
  events:
    next:
      targetState: DETAILS_DELETED_PAGE

DETAILS_DELETED_PAGE:
  response:
    type: page
    pageId: pyi-details-deleted
  events:
    next:
      targetJourney: NEW_P2_IDENTITY
      targetState: START

UPDATE_DETAILS_PAGE:
  response:
    type: page
    pageId: update-details
  events:
    address:
      targetJourney: UPDATE_ADDRESS
      targetState: START
    name:
      # TODO replace with UPDATE_NAME_ADDRESS when it is complete
      targetJourney: UPDATE_ADDRESS
      targetState: START
    name-address:
      # TODO replace with UPDATE_NAME_ADDRESS when it is complete
      targetJourney: UPDATE_ADDRESS
      targetState: START
    names-dob:
      targetState: UPDATE_NAME_DOB_PAGE
    cancel:
      targetState: RETURN_TO_RP

UPDATE_NAME_DOB_PAGE:
  response:
    type: page
    pageId: update-name-date-birth
  events:
    end:
      targetState: UPDATE_DETAILS_PAGE

RETURN_TO_RP:
  response:
    type: process
    lambda: build-client-oauth-response
