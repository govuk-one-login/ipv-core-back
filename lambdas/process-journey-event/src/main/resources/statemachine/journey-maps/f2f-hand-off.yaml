name: F2F Hand Off
description: >-
  The routes a user to proving their identity with f2f.

states:
  # Entry points
  START_MEDIUM_CONFIDENCE:
    events:
      next:
        targetState: PROCESS_PENDING_IDENTITY
        journeyContextToSet: mediumConfidence
  START_LOW_CONFIDENCE:
    events:
      next:
        targetState: PROCESS_PENDING_IDENTITY
        journeyContextToSet: lowConfidence

  # Parent states
  CRI_STATE:
    events:
      not-found:
        targetJourney: FAILED
        targetState: FAILED
      fail-with-no-ci:
        targetJourney: FAILED
        targetState: FAILED
      error:
        targetJourney: TECHNICAL_ERROR
        targetState: ERROR
      access-denied:
        targetJourney: FAILED
        targetState: FAILED
      invalid-request:
        targetJourney: FAILED
        targetState: FAILED
      temporarily-unavailable:
        targetJourney: TECHNICAL_ERROR
        targetState: ERROR
      fail-with-ci:
        targetJourney: FAILED
        targetState: FAILED
      vcs-not-correlated:
        targetJourney: FAILED
        targetState: FAILED
      dl-auth-source-check:
        targetJourney: TECHNICAL_ERROR
        targetState: ERROR

  # Journey states
  PROCESS_PENDING_IDENTITY:
    response:
      type: process
      lambda: process-candidate-identity
      lambdaInput:
        identityType: PENDING
    events:
      next:
        targetState: CRI_F2F
      account-intervention:
        targetJourney: FAILED
        targetState: FAILED_ACCOUNT_INTERVENTION
      coi-check-failed:
        targetJourney: FAILED
        targetState: FAILED
      vcs-not-correlated:
        targetJourney: FAILED
        targetState: FAILED
      profile-unmet:
        targetJourney: FAILED
        targetState: FAILED
      fail-with-ci:
        targetJourney: FAILED
        targetState: FAILED_NO_TICF
      error:
        targetJourney: TECHNICAL_ERROR
        targetState: ERROR

  CRI_F2F:
    response:
      type: cri
      criId: f2f
    parent: CRI_STATE
    events:
      next:
        targetState: RESET_SESSION_BEFORE_F2F_HANDOFF
      access-denied:
        targetJourney: INELIGIBLE
        targetState: INELIGIBLE_NO_TICF
      not-found:
        targetJourney: FAILED
        targetState: FAILED_NO_TICF
      fail-with-no-ci:
        targetJourney: FAILED
        targetState: FAILED_NO_TICF
      fail-with-ci:
        targetJourney: FAILED
        targetState: FAILED_NO_TICF
      vcs-not-correlated:
        targetJourney: FAILED
        targetState: FAILED_NO_TICF
      error:
        targetState: SORRY_CRI_TECHNICAL_PROBLEM_CRI_F2F
      temporarily-unavailable:
        targetJourney: TECHNICAL_ERROR
        targetState: ERROR_NO_TICF

  SORRY_CRI_TECHNICAL_PROBLEM_CRI_F2F:
    response:
      type: page
      pageId: sorry-technical-problem
      context: f2fCriError
    events:
      tryAgain:
        targetState: CRI_F2F
      app:
        targetJourney: TECHNICAL_ERROR
        targetState: ERROR_NO_TICF
        checkJourneyContext:
          mediumConfidence:
            targetState: RESET_SESSION_BEFORE_IDENTITY_DOCUMENT_START
          lowConfidence:
            targetState: RESET_SESSION_BEFORE_IDENTITY_DOCUMENT_START
      webRoute:
        targetJourney: TECHNICAL_ERROR
        targetState: ERROR_NO_TICF
        checkJourneyContext:
          mediumConfidence:
            targetState: RESET_SESSION_BEFORE_DCMAW_ASYNC_ANOTHER_WAY
          lowConfidence:
            targetState: RESET_SESSION_BEFORE_DCMAW_ASYNC_ANOTHER_WAY
      returnToRp:
        targetState: RETURN_TO_RP

  RESET_SESSION_BEFORE_IDENTITY_DOCUMENT_START:
    response:
      type: process
      lambda: reset-session-identity
      lambdaInput:
        resetType: ALL
    events:
      next:
        checkJourneyContext:
          mediumConfidence:
            targetJourney: NEW_P2_IDENTITY
            targetState: IDENTITY_DOCUMENT_START
          lowConfidence:
            targetJourney: NEW_P1_IDENTITY
            targetState: IDENTITY_DOCUMENT_START
      error:
        checkJourneyContext:
          mediumConfidence:
            targetJourney: NEW_P2_IDENTITY
            targetState: IDENTITY_DOCUMENT_START
          lowConfidence:
            targetJourney: NEW_P1_IDENTITY
            targetState: IDENTITY_DOCUMENT_START

  RESET_SESSION_BEFORE_DCMAW_ASYNC_ANOTHER_WAY:
    response:
      type: process
      lambda: reset-session-identity
      lambdaInput:
        resetType: ALL
    events:
      next:
        checkJourneyContext:
          mediumConfidence:
            targetJourney: NEW_P2_IDENTITY
            targetState: DCMAW_ASYNC_ANOTHER_WAY
          lowConfidence:
            targetJourney: NEW_P1_IDENTITY
            targetState: DCMAW_ASYNC_ANOTHER_WAY
      error:
        checkJourneyContext:
          mediumConfidence:
            targetJourney: NEW_P2_IDENTITY
            targetState: DCMAW_ASYNC_ANOTHER_WAY
          lowConfidence:
            targetJourney: NEW_P1_IDENTITY
            targetState: DCMAW_ASYNC_ANOTHER_WAY

  RESET_SESSION_BEFORE_F2F_HANDOFF:
    response:
      type: process
      lambda: reset-session-identity
      lambdaInput:
        resetType: ALL
    events:
      next:
        targetState: F2F_HANDOFF_PAGE
      error:
        targetState: F2F_HANDOFF_PAGE

  F2F_HANDOFF_PAGE:
    response:
      type: page
      pageId: page-face-to-face-handoff

  RETURN_TO_RP:
    response:
      type: process
      lambda: build-client-oauth-response
