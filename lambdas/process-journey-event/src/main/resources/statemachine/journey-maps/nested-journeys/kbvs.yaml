name: KBV challenge routing
description: >-
  The combined journey for enabled KBV CRIs.

  When redirecting to a KBV CRI, IPV Core will request a verification score
  corresponding to the target Vector of Trust (P1 or P2).
entryEvents:
  next:
    targetState: PRE_DWP_KBV_PIP_PAGE
    checkIfDisabled:
      dwpKbv:
        targetState: CRI_NINO
        checkIfDisabled:
          hmrcKbv:
            targetState: PRE_EXPERIAN_PAGE
  next-with-nino:
    targetState: PRE_DWP_KBV_PIP_PAGE
    checkIfDisabled:
      dwpKbv:
        targetState: CRI_HMRC_KBV
        checkIfDisabled:
          hmrcKbv:
            targetState: PRE_EXPERIAN_PAGE
nestedJourneyStates:
  CRI_NINO:
    response:
      type: cri
      criId: nino
    parent: CRI_STATE
    events:
      next:
        targetState: CRI_HMRC_KBV
      fail-with-no-ci:
        targetState: PRE_EXPERIAN_PAGE
  CRI_DWP_KBV:
    response:
      type: cri
      criId: dwpKbv
    parent: CRI_STATE
    events:
      next:
        exitEventToEmit: next
      enhanced-verification:
        exitEventToEmit: enhanced-verification
      invalid-request:
        targetState: PRE_EXPERIAN_PAGE
      access-denied:
        targetState: PRE_EXPERIAN_PAGE
  CRI_HMRC_KBV:
    response:
      type: cri
      criId: hmrcKbv
    parent: CRI_STATE
    events:
      next:
        exitEventToEmit: next
      enhanced-verification:
        exitEventToEmit: enhanced-verification
      invalid-request:
        targetState: PRE_EXPERIAN_PAGE
      access-denied:
        targetState: PRE_EXPERIAN_PAGE
  CRI_EXPERIAN_KBV:
    response:
      type: cri
      criId: kbv
    parent: CRI_STATE
    events:
      fail-with-no-ci:
        exitEventToEmit: fail-with-no-ci
      next:
        exitEventToEmit: next
      enhanced-verification:
        exitEventToEmit: enhanced-verification
  PRE_EXPERIAN_PAGE:
    response:
      type: page
      pageId: page-pre-experian-kbv-transition
    events:
      next:
        targetState: CRI_EXPERIAN_KBV
  PRE_DWP_KBV_PIP_PAGE:
    response:
      type: page
      pageId: personal-independence-payment
    events:
      next:
        targetState: PRE_DWP_KBV_TRANSITION_PAGE
      end:
        targetState: CRI_NINO
        checkIfDisabled:
          hmrcKbv:
            targetState: PRE_EXPERIAN_PAGE
  PRE_DWP_KBV_TRANSITION_PAGE:
    response:
      type: page
      pageId: page-pre-dwp-kbv-transition
    events:
      next:
        targetState: CRI_DWP_KBV
      end:
        exitEventToEmit: end
