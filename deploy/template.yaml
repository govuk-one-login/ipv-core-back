AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >-
  This creates the necessary serverless components for IPV Core-Back.

Globals:
  Function:
    Timeout: 40
    Environment:
      Variables:
        JAVA_TOOL_OPTIONS: -XX:+TieredCompilation -XX:TieredStopAtLevel=1

Parameters:
  Environment:
    Type: String
  PassportCriId:
    Type: String
    Description: The passport cri id which relates to the cri config in parameter store to be used by the journey engine
    Default: ukPassport
  FraudCriId:
    Type: String
    Description: The fraud cri id which relates to the cri config in parameter store to be used by the journey engine
    Default: fraud
  KbvCriId:
    Type: String
    Description: The kbv cri id which relates to the cri config in parameter store to be used by the journey engine
    Default: kbv
  AddressCriId:
    Type: String
    Description: The address cri id which relates to the cri config in parameter store to be used by the journey engine
    Default: address

Conditions:
  AddProvisionedConcurrency: !Not
    - !Equals
      - !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, provisionedConcurrency ]
      -  0
  IsDevelopmentEnvironment: !Not
    - !Or
      - !Equals [ !Ref Environment, "build"]
      - !Equals [ !Ref Environment, "staging"]
      - !Equals [ !Ref Environment, "integration"]
      - !Equals [ !Ref Environment, "production"]

# The AWS Account Id is used in the following mapping section because we have
# multiple developer environments and it is undesirable to have to keep this
# mapping up to date with each developer environment.
Mappings:
  EnvironmentConfiguration:
    "130355686670": # Development
      provisionedConcurrency: 0
    "457601271792": # Build
      provisionedConcurrency: 0
    "335257547869": # Staging
      provisionedConcurrency: 1
    "991138514218": # Integration
      provisionedConcurrency: 1
    "075701497069": # Production
      provisionedConcurrency: 1

Resources:
  IPVCorePrivateAPI:
    Type: AWS::Serverless::Api
    Properties:
      # checkov:skip=CKV_AWS_120: We are not implementing API Gateway caching at the time.
      Name: !Sub IPV Core Private API Gateway ${Environment}
      EndpointConfiguration:
        Type: PRIVATE
      Auth:
        ResourcePolicy:
          CustomStatements:
            - Action: 'execute-api:Invoke'
              Effect: Allow
              Principal: '*'
              Resource:
                - 'execute-api:/*'
            - Action: 'execute-api:Invoke'
              Effect: Deny
              Principal: '*'
              Resource:
                - 'execute-api:/*'
              Condition:
                StringNotEquals:
                  'aws:SourceVpce': !If
                    - IsDevelopmentEnvironment
                    - !ImportValue "network-shared-development-ApiGatewayVpcEndpointId"
                    - Fn::ImportValue:
                        !Sub "networking-${Environment}-ApiGatewayVpcEndpointId"
      StageName: !Sub ${Environment}
      TracingEnabled: true
      AccessLogSetting:
        DestinationArn: !GetAtt IPVCorePrivateAPILogGroup.Arn
        Format: >-
          {
          "requestId":"$context.requestId",
          "ip":"$context.identity.sourceIp",
          "requestTime":"$context.requestTime",
          "httpMethod":"$context.httpMethod",
          "path":"$context.path",
          "routeKey":"$context.routeKey",
          "status":"$context.status",
          "protocol":"$context.protocol",
          "responseLatency":"$context.responseLatency",
          "responseLength":"$context.responseLength"
          }

  IPVCorePrivateAPILogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/apigateway/${AWS::StackName}-CoreBackPrivate-API-GW-AccessLogs
      RetentionInDays: 14
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  IPVCorePrivateAPILogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod"
      FilterPattern: ""
      LogGroupName: !Ref IPVCorePrivateAPILogGroup

  IPVCoreExternalAPI:
    Type: AWS::Serverless::Api
    Properties:
      # checkov:skip=CKV_AWS_120: We are not implementing API Gateway caching at the time.
      Name: !Sub IPV Core External API Gateway ${Environment}
      StageName: !Sub ${Environment}
      TracingEnabled: true
      DefinitionBody:
        'Fn::Transform':
          Name: "AWS::Include"
          Parameters:
            Location: "../openAPI/core-back-external.yaml"
      AccessLogSetting:
        DestinationArn: !GetAtt IPVCoreExternalAPILogGroup.Arn
        Format: >-
          {
          "requestId":"$context.requestId",
          "ip":"$context.identity.sourceIp",
          "requestTime":"$context.requestTime",
          "httpMethod":"$context.httpMethod",
          "path":"$context.path",
          "routeKey":"$context.routeKey",
          "status":"$context.status",
          "protocol":"$context.protocol",
          "responseLatency":"$context.responseLatency",
          "responseLength":"$context.responseLength"
          }

  IPVCoreExternalAPILogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/apigateway/${AWS::StackName}-CoreBackExternal-API-GW-AccessLogs
      RetentionInDays: 14
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  IPVCoreExternalAPILogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod"
      FilterPattern: ""
      LogGroupName: !Ref IPVCoreExternalAPILogGroup

  IPVAccessTokenFunction:
    Type: AWS::Serverless::Function
    Properties:
      # checkov:skip=CKV_AWS_116: Lambdas invoked via API Gateway do not support Dead Letter Queues.
      FunctionName: !Sub "ipv-access-token-${Environment}"
      Handler: uk.gov.di.ipv.core.accesstoken.AccessTokenHandler::handleRequest
      Runtime: java11
      PackageType: Zip
      CodeUri: ../lambdas/accesstoken
      Architectures:
        - arm64
      MemorySize: 2048
      Tracing: Active
      Environment:
        # checkov:skip=CKV_AWS_173: These environment variables do not require encryption.
        Variables:
          ENVIRONMENT: !Sub "${Environment}"
          POWERTOOLS_SERVICE_NAME: !Sub access-token-${Environment}
          AUTH_CODES_TABLE_NAME: !Select [1, !Split ['/', !GetAtt AuthCodesTable.Arn]]
          ACCESS_TOKENS_TABLE_NAME: !Select [1, !Split ['/', !GetAtt AccessTokensTable.Arn]]
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref AccessTokensTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AuthCodesTable
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/clients/*
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/audienceForClients
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/maxAllowedAuthClientTtl
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/backendSessionTtl
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/authCodeExpirySeconds
      Events:
        IPVCoreExternalAPI:
          Type: Api
          Properties:
            RestApiId: !Ref IPVCoreExternalAPI
            Path: /token
            Method: POST
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        !If
          - AddProvisionedConcurrency
          - ProvisionedConcurrentExecutions: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, provisionedConcurrency ]
          - !Ref AWS::NoValue

  IPVAccessTokenFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 14
      LogGroupName: !Sub "/aws/lambda/${IPVAccessTokenFunction}"
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  IPVAccessTokenFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod"
      FilterPattern: ""
      LogGroupName: !Ref IPVAccessTokenFunctionLogGroup

  IPVSessionEndFunction:
    Type: AWS::Serverless::Function
    Properties:
      # checkov:skip=CKV_AWS_116: Lambdas invoked via API Gateway do not support Dead Letter Queues.
      FunctionName: !Sub "ipv-session-end-${Environment}"
      Handler: uk.gov.di.ipv.core.sessionend.SessionEndHandler::handleRequest
      Runtime: java11
      PackageType: Zip
      CodeUri: ../lambdas/sessionend
      Architectures:
        - arm64
      MemorySize: 2048
      Tracing: Active
      Environment:
        # checkov:skip=CKV_AWS_173: These environment variables do not require encryption.
        Variables:
          ENVIRONMENT: !Sub "${Environment}"
          POWERTOOLS_SERVICE_NAME: !Sub session-end-${Environment}
          AUTH_CODES_TABLE_NAME: !Select [1, !Split ['/', !GetAtt AuthCodesTable.Arn]]
          IPV_SESSIONS_TABLE_NAME: !Ref SessionsTable
          SQS_AUDIT_EVENT_QUEUE_URL: !ImportValue AuditEventQueueUrl
      Policies:
        - DynamoDBWritePolicy:
            TableName: !Ref AuthCodesTable
        - DynamoDBReadPolicy:
            TableName: !Ref AuthCodesTable
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
        - SSMParameterReadPolicy:
              ParameterName: !Sub ${Environment}/core/*
        - SQSSendMessagePolicy:
            QueueName: !ImportValue AuditEventQueueName
        - Statement:
            - Sid: kmsAuditEventQueueEncryptionKeyPermission
              Effect: Allow
              Action:
                - 'kms:Decrypt'
                - 'kms:GenerateDataKey'
              Resource:
                - !ImportValue AuditEventQueueEncryptionKeyArn
      Events:
        IPVCorePrivateAPI:
          Type: Api
          Properties:
            RestApiId:
              Ref: IPVCorePrivateAPI
            Path: /journey/session/end
            Method: POST
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        !If
          - AddProvisionedConcurrency
          - ProvisionedConcurrentExecutions: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, provisionedConcurrency ]
          - !Ref AWS::NoValue

  IPVSessionEndFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 14
      LogGroupName: !Sub "/aws/lambda/${IPVSessionEndFunction}"
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  IPVSessionEndFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod"
      FilterPattern: ""
      LogGroupName: !Ref IPVSessionEndFunctionLogGroup

  IPVSessionStartFunction:
    Type: AWS::Serverless::Function
    Properties:
      # checkov:skip=CKV_AWS_116: Lambdas invoked via API Gateway do not support Dead Letter Queues.
      FunctionName: !Sub "ipv-session-start-${Environment}"
      Handler: uk.gov.di.ipv.core.session.IpvSessionStartHandler::handleRequest
      Runtime: java11
      PackageType: Zip
      CodeUri: ../lambdas/sessionstart
      Architectures:
        - arm64
      MemorySize: 2048
      Tracing: Active
      Environment:
        # checkov:skip=CKV_AWS_173: These environment variables do not require encryption.
        Variables:
          ENVIRONMENT: !Sub "${Environment}"
          POWERTOOLS_SERVICE_NAME: !Sub session-start-${Environment}
          IPV_SESSIONS_TABLE_NAME: !Select [1, !Split ['/', !GetAtt SessionsTable.Arn]]
          SQS_AUDIT_EVENT_QUEUE_URL: !ImportValue AuditEventQueueUrl
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTable
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/clients/*
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/audienceForClients
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/maxAllowedAuthClientTtl
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/jarKmsEncryptionKeyId
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/backendSessionTtl
        - SQSSendMessagePolicy:
            QueueName: !ImportValue AuditEventQueueName
        - Statement:
            - Sid: jarKmsEncryptionKeyPermission
              Effect: Allow
              Action:
                - 'kms:Decrypt'
                - 'kms:GenerateDataKey'
              Resource:
                - !ImportValue CoreEncryptionKeyArn
            - Sid: kmsAuditEventQueueEncryptionKeyPermission
              Effect: Allow
              Action:
                - 'kms:Decrypt'
                - 'kms:GenerateDataKey'
              Resource:
                - !ImportValue AuditEventQueueEncryptionKeyArn
      Events:
        IPVCorePrivateAPI:
          Type: Api
          Properties:
            RestApiId:
              Ref: IPVCorePrivateAPI
            Path: /session/start
            Method: POST
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        !If
          - AddProvisionedConcurrency
          - ProvisionedConcurrentExecutions: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, provisionedConcurrency ]
          - !Ref AWS::NoValue

  IPVSessionStartFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 14
      LogGroupName: !Sub "/aws/lambda/${IPVSessionStartFunction}"
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  IPVSessionStartFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod"
      FilterPattern: ""
      LogGroupName: !Ref IPVSessionStartFunctionLogGroup

  IPVCriReturnFunction:
    Type: AWS::Serverless::Function
    Properties:
      # checkov:skip=CKV_AWS_116: Lambdas invoked via API Gateway do not support Dead Letter Queues.
      FunctionName: !Sub "ipv-credential-issuer-return-${Environment}"
      Handler: uk.gov.di.ipv.core.credentialissuerreturn.CredentialIssuerReturnHandler::handleRequest
      Runtime: java11
      PackageType: Zip
      CodeUri: ../lambdas/credentialissuerreturn
      Architectures:
        - arm64
      MemorySize: 2048
      Tracing: Active
      Environment:
        # checkov:skip=CKV_AWS_173: These environment variables do not require encryption.
        Variables:
          CREDENTIAL_ISSUERS_CONFIG_PARAM_PREFIX: !Sub "/${Environment}/core/credentialIssuers"
          USER_ISSUED_CREDENTIALS_TABLE_NAME: !Select [1, !Split ['/', !GetAtt UserIssuedCredentialsTable.Arn]]
          SIGNING_KEY_ID_PARAM: !Sub "/${Environment}/core/self/signingKeyId"
          ENVIRONMENT: !Sub "${Environment}"
          POWERTOOLS_SERVICE_NAME: !Sub cri-return-${Environment}
          SQS_AUDIT_EVENT_QUEUE_URL: !ImportValue AuditEventQueueUrl
          IPV_SESSIONS_TABLE_NAME: !Ref SessionsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UserIssuedCredentialsTable
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTable
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/credentialIssuers/*
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/credentialIssuers
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/coreFrontCallbackUrl
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/signingKeyId
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/jwtTtlSeconds
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/audienceForClients
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/backendSessionTtl
        - AWSSecretsManagerGetSecretValuePolicy:
            SecretArn: !Sub arn:aws:secretsmanager:eu-west-2:*:secret:${Environment}/credential-issuers/*/api-key-*
        - SQSSendMessagePolicy:
            QueueName: !ImportValue AuditEventQueueName
        - Statement:
          - Sid: kmsSigningKeyPermission
            Effect: Allow
            Action:
              - 'kms:sign'
            Resource:
              - !ImportValue SigningKeyArn
          - Sid: kmsAuditEventQueueEncryptionKeyPermission
            Effect: Allow
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey'
            Resource:
              - !ImportValue AuditEventQueueEncryptionKeyArn
      Events:
        IPVCorePrivateAPI:
          Type: Api
          Properties:
            RestApiId:
              Ref: IPVCorePrivateAPI
            Path: /journey/cri/return
            Method: POST
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        !If
          - AddProvisionedConcurrency
          - ProvisionedConcurrentExecutions: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, provisionedConcurrency ]
          - !Ref AWS::NoValue

  IPVCriReturnFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 14
      LogGroupName: !Sub "/aws/lambda/${IPVCriReturnFunction}"
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  IPVCriReturnFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod"
      FilterPattern: ""
      LogGroupName: !Ref IPVCriReturnFunctionLogGroup

  IPVCredentialIssuerStartFunction:
    Type: AWS::Serverless::Function
    Properties:
      # checkov:skip=CKV_AWS_116: Lambdas invoked via API Gateway do not support Dead Letter Queues.
      FunctionName: !Sub "ipv-credential-issuer-start-${Environment}"
      Handler: uk.gov.di.ipv.core.credentialissuer.CredentialIssuerStartHandler::handleRequest
      Runtime: java11
      PackageType: Zip
      CodeUri: ../lambdas/credentialissuerstart
      Architectures:
        - arm64
      MemorySize: 3008
      Tracing: Active
      Environment:
        # checkov:skip=CKV_AWS_173: These environment variables do not require encryption.
        Variables:
          CREDENTIAL_ISSUERS_CONFIG_PARAM_PREFIX: !Sub "/${Environment}/core/credentialIssuers"
          ENVIRONMENT: !Sub "${Environment}"
          POWERTOOLS_SERVICE_NAME: !Sub credential-issuer-start-${Environment}
          USER_ISSUED_CREDENTIALS_TABLE_NAME: !Select [ 1, !Split [ '/', !GetAtt UserIssuedCredentialsTable.Arn ] ]
          SIGNING_KEY_ID_PARAM: !Sub "/${Environment}/core/self/signingKeyId"
          SQS_AUDIT_EVENT_QUEUE_URL: !ImportValue AuditEventQueueUrl
          IPV_SESSIONS_TABLE_NAME: !Ref SessionsTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UserIssuedCredentialsTable
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTable
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/signingKeyId
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/jwtTtlSeconds
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/audienceForClients
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/coreFrontCallbackUrl
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/credentialIssuers/*
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/credentialIssuers
        - SQSSendMessagePolicy:
            QueueName: !ImportValue AuditEventQueueName
        - Statement:
            - Sid: kmsSigningKeyPermission
              Effect: Allow
              Action:
                - 'kms:sign'
              Resource:
                - !ImportValue SigningKeyArn
            - Sid: kmsAuditEventQueueEncryptionKeyPermission
              Effect: Allow
              Action:
                - 'kms:Decrypt'
                - 'kms:GenerateDataKey'
              Resource:
                - !ImportValue AuditEventQueueEncryptionKeyArn
      Events:
        IPVCorePrivateAPI:
          Type: Api
          Properties:
            RestApiId:
              Ref: IPVCorePrivateAPI
            Path: /journey/cri/start/{criId}
            Method: POST
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        !If
          - AddProvisionedConcurrency
          - ProvisionedConcurrentExecutions: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, provisionedConcurrency ]
          - !Ref AWS::NoValue

  IPVCredentialIssuerStartFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 14
      LogGroupName: !Sub "/aws/lambda/${IPVCredentialIssuerStartFunction}"
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  IPVCredentialIssuerStartFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod"
      FilterPattern: ""
      LogGroupName: !Ref IPVCredentialIssuerStartFunctionLogGroup

  IPVCredentialIssuerErrorFunction:
    Type: AWS::Serverless::Function
    Properties:
      # checkov:skip=CKV_AWS_116: Lambdas invoked via API Gateway do not support Dead Letter Queues.
      FunctionName: !Sub "ipv-credential-issuer-error-${Environment}"
      Handler: uk.gov.di.ipv.core.credentialissuererror.CredentialIssuerErrorHandler::handleRequest
      Runtime: java11
      PackageType: Zip
      CodeUri: ../lambdas/credentialissuererror
      Architectures:
        - arm64
      MemorySize: 3008
      Tracing: Active
      Environment:
        # checkov:skip=CKV_AWS_173: These environment variables do not require encryption.
        Variables:
          ENVIRONMENT: !Sub "${Environment}"
          POWERTOOLS_SERVICE_NAME: !Sub credential-issuer-error-${Environment}
          IPV_SESSIONS_TABLE_NAME: !Ref SessionsTable
          SQS_AUDIT_EVENT_QUEUE_URL: !ImportValue AuditEventQueueUrl
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTable
        - SQSSendMessagePolicy:
            QueueName: !ImportValue AuditEventQueueName
        - Statement:
            - Sid: kmsAuditEventQueueEncryptionKeyPermission
              Effect: Allow
              Action:
                - 'kms:Decrypt'
                - 'kms:GenerateDataKey'
              Resource:
                - !ImportValue AuditEventQueueEncryptionKeyArn
      Events:
        IPVCorePrivateAPI:
          Type: Api
          Properties:
            RestApiId:
              Ref: IPVCorePrivateAPI
            Path: /journey/cri/error
            Method: POST
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        !If
          - AddProvisionedConcurrency
          - ProvisionedConcurrentExecutions: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, provisionedConcurrency ]
          - !Ref AWS::NoValue

  IPVCredentialIssuerErrorFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 14
      LogGroupName: !Sub "/aws/lambda/${IPVCredentialIssuerErrorFunction}"
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  IPVCredentialIssuerErrorFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod"
      FilterPattern: ""
      LogGroupName: !Ref IPVCredentialIssuerErrorFunctionLogGroup

  IPVUserIdentityFunction:
    Type: AWS::Serverless::Function
    Properties:
      # checkov:skip=CKV_AWS_116: Lambdas invoked via API Gateway do not support Dead Letter Queues.
      FunctionName: !Sub "ipv-user-identity-${Environment}"
      Handler: uk.gov.di.ipv.core.useridentity.UserIdentityHandler::handleRequest
      Runtime: java11
      PackageType: Zip
      CodeUri: ../lambdas/useridentity
      Architectures:
        - arm64
      MemorySize: 2048
      Tracing: Active
      Environment:
        # checkov:skip=CKV_AWS_173: These environment variables do not require encryption.
        Variables:
          ENVIRONMENT: !Sub "${Environment}"
          POWERTOOLS_SERVICE_NAME: !Sub user-identity-${Environment}
          ACCESS_TOKENS_TABLE_NAME: !Select [1, !Split ['/', !GetAtt AccessTokensTable.Arn]]
          USER_ISSUED_CREDENTIALS_TABLE_NAME: !Select [1, !Split ['/', !GetAtt UserIssuedCredentialsTable.Arn]]
          IPV_SESSIONS_TABLE_NAME: !Select [ 1, !Split [ '/', !GetAtt SessionsTable.Arn ] ]
          SQS_AUDIT_EVENT_QUEUE_URL: !ImportValue AuditEventQueueUrl
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UserIssuedCredentialsTable
        - DynamoDBWritePolicy:
            TableName: !Ref UserIssuedCredentialsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AccessTokensTable
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
        - SQSSendMessagePolicy:
            QueueName: !ImportValue AuditEventQueueName
        - Statement:
            - Sid: kmsAuditEventQueueEncryptionKeyPermission
              Effect: Allow
              Action:
                - 'kms:Decrypt'
                - 'kms:GenerateDataKey'
              Resource:
                - !ImportValue AuditEventQueueEncryptionKeyArn
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/coreVtmClaim
      Events:
        IPVCoreExternalAPI:
          Type: Api
          Properties:
            RestApiId:
              Ref: IPVCoreExternalAPI
            Path: /user-identity
            Method: GET
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        !If
          - AddProvisionedConcurrency
          - ProvisionedConcurrentExecutions: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, provisionedConcurrency ]
          - !Ref AWS::NoValue

  IPVUserIdentityFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 14
      LogGroupName: !Sub "/aws/lambda/${IPVUserIdentityFunction}"
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  IPVUserIdentityFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod"
      FilterPattern: ""
      LogGroupName: !Ref IPVUserIdentityFunctionLogGroup

  IPVCredentialIssuerConfig:
    Type: AWS::Serverless::Function
    Properties:
      # checkov:skip=CKV_AWS_116: Lambdas invoked via API Gateway do not support Dead Letter Queues.
      FunctionName: !Sub "credential-issuer-config-${Environment}"
      Handler: uk.gov.di.ipv.core.credentialissuerconfig.CredentialIssuerConfigHandler::handleRequest
      Runtime: java11
      PackageType: Zip
      CodeUri: ../lambdas/credentialissuerconfig
      Architectures:
        - arm64
      MemorySize: 2048
      Tracing: Active
      Environment:
        # checkov:skip=CKV_AWS_173: These environment variables do not require encryption.
        Variables:
          ENVIRONMENT: !Sub "${Environment}"
          POWERTOOLS_SERVICE_NAME: !Sub credential-issuer-config-${Environment}
          CREDENTIAL_ISSUERS_CONFIG_PARAM_PREFIX: !Sub "/${Environment}/core/credentialIssuers"
      Policies:
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/credentialIssuers/*
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/credentialIssuers
      Events:
        IPVCorePrivateAPI:
          Type: Api
          Properties:
            RestApiId:
              Ref: IPVCorePrivateAPI
            Path: /request-config
            Method: GET
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        !If
          - AddProvisionedConcurrency
          - ProvisionedConcurrentExecutions: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, provisionedConcurrency ]
          - !Ref AWS::NoValue

  IPVCredentialIssuerFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 14
      LogGroupName: !Sub "/aws/lambda/${IPVCredentialIssuerConfig}"
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  IPVCredentialIssuerFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod"
      FilterPattern: ""
      LogGroupName: !Ref IPVCredentialIssuerFunctionLogGroup

  IPVIssuedCredentials:
    Type: AWS::Serverless::Function
    Properties:
      # checkov:skip=CKV_AWS_116: Lambdas invoked via API Gateway do not support Dead Letter Queues.
      FunctionName: !Sub "issued-credentials-${Environment}"
      Handler: uk.gov.di.ipv.core.issuedcredentials.IssuedCredentialsHandler::handleRequest
      Runtime: java11
      PackageType: Zip
      CodeUri: ../lambdas/issuedcredentials
      Architectures:
        - arm64
      MemorySize: 2048
      Tracing: Active
      Environment:
        # checkov:skip=CKV_AWS_173: These environment variables do not require encryption.
        Variables:
          ENVIRONMENT: !Sub "${Environment}"
          POWERTOOLS_SERVICE_NAME: !Sub issued-credentials-${Environment}
          USER_ISSUED_CREDENTIALS_TABLE_NAME: !Select [1, !Split ['/', !GetAtt UserIssuedCredentialsTable.Arn]]
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UserIssuedCredentialsTable
        - DynamoDBWritePolicy:
            TableName: !Ref UserIssuedCredentialsTable
      Events:
        IPVCorePrivateAPI:
          Type: Api
          Properties:
            RestApiId:
              Ref: IPVCorePrivateAPI
            Path: /issued-credentials
            Method: GET
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        !If
          - AddProvisionedConcurrency
          - ProvisionedConcurrentExecutions: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, provisionedConcurrency ]
          - !Ref AWS::NoValue

  IPVIssuedCredentialsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 14
      LogGroupName: !Sub "/aws/lambda/${IPVIssuedCredentials}"
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  IPVIssuedCredentialsFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod"
      FilterPattern: ""
      LogGroupName: !Ref IPVIssuedCredentialsFunctionLogGroup

  IPVJourneyEngineFunction:
    Type: AWS::Serverless::Function
    Properties:
      # checkov:skip=CKV_AWS_116: Lambdas invoked via API Gateway do not support Dead Letter Queues.
      FunctionName: !Sub "journey-engine-${Environment}"
      Handler: uk.gov.di.ipv.core.journeyengine.JourneyEngineHandler::handleRequest
      Runtime: java11
      PackageType: Zip
      CodeUri: ../lambdas/journeyengine
      Architectures:
        - arm64
      MemorySize: 2048
      Tracing: Active
      Environment:
        # checkov:skip=CKV_AWS_173: These environment variables do not require encryption.
        Variables:
          ENVIRONMENT: !Sub "${Environment}"
          POWERTOOLS_SERVICE_NAME: !Sub session-${Environment}
          IPV_SESSIONS_TABLE_NAME: !Ref SessionsTable
          IPV_JOURNEY_CRI_START_URI: "/journey/cri/start/"
          IPV_JOURNEY_SESSION_END_URI: "/journey/session/end"
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBWritePolicy:
            TableName: !Ref SessionsTable
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/backendSessionTimeout
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/journey/passportCriId
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/journey/addressCriId
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/journey/fraudCriId
        - SSMParameterReadPolicy:
            ParameterName: !Sub ${Environment}/core/self/journey/kbvCriId
      Events:
        IPVCorePrivateAPI:
          Type: Api
          Properties:
            RestApiId:
              Ref: IPVCorePrivateAPI
            Path: /journey/{journeyStep}
            Method: POST
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        !If
          - AddProvisionedConcurrency
          - ProvisionedConcurrentExecutions: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, provisionedConcurrency ]
          - !Ref AWS::NoValue

  IPVJourneyEngineFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 14
      LogGroupName: !Sub "/aws/lambda/${IPVJourneyEngineFunction}"
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  IPVJourneyEngineFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod"
      FilterPattern: ""
      LogGroupName: !Ref IPVJourneyEngineFunctionLogGroup

  IPVValidateCriCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      # checkov:skip=CKV_AWS_116: Lambdas invoked via API Gateway do not support Dead Letter Queues.
      FunctionName: !Sub "validate-cri-check-${Environment}"
      Handler: uk.gov.di.ipv.core.validatecricheck.ValidateCriCheckHandler::handleRequest
      Runtime: java11
      PackageType: Zip
      CodeUri: ../lambdas/validatecricheck
      Architectures:
        - arm64
      MemorySize: 2048
      Tracing: Active
      Environment:
        # checkov:skip=CKV_AWS_173: These environment variables do not require encryption.
        Variables:
          ENVIRONMENT: !Ref Environment
          POWERTOOLS_SERVICE_NAME: !Sub validate-cri-check-${Environment}
          USER_ISSUED_CREDENTIALS_TABLE_NAME: !Ref UserIssuedCredentialsTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UserIssuedCredentialsTable
      Events:
        IPVCorePrivateAPI:
          Type: Api
          Properties:
            RestApiId:
              Ref: IPVCorePrivateAPI
            Path: /journey/cri/validate/{criId}
            Method: POST
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        !If
          - AddProvisionedConcurrency
          - ProvisionedConcurrentExecutions: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, provisionedConcurrency ]
          - !Ref AWS::NoValue

  IPVValidateCriCheckFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 14
      LogGroupName: !Sub "/aws/lambda/${IPVValidateCriCheckFunction}"
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  IPVValidateCriCheckFunctionLogGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prod"
      FilterPattern: ""
      LogGroupName: !Ref IPVValidateCriCheckFunctionLogGroup

  UserIssuedCredentialsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      # checkov:skip=CKV_AWS_28: Point in time recovery is not necessary for this table.
      TableName: !Sub "user-issued-credentials-${Environment}"
      BillingMode: "PAY_PER_REQUEST"
      AttributeDefinitions:
        - AttributeName: "ipvSessionId"
          AttributeType: "S"
        - AttributeName: "credentialIssuer"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "ipvSessionId"
          KeyType: "HASH"
        - AttributeName: "credentialIssuer"
          KeyType: "RANGE"
      TimeToLiveSpecification:
        AttributeName: "ttl"
        Enabled: true
      SSESpecification:
        # checkov:skip=CKV_AWS_119: Implement Customer Managed Keys in PYIC-1391
        SSEEnabled: true
        SSEType: KMS

  AuthCodesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      # checkov:skip=CKV_AWS_28: Point in time recovery is not necessary for this table.
      TableName: !Sub "auth-codes-${Environment}"
      BillingMode: "PAY_PER_REQUEST"
      AttributeDefinitions:
        - AttributeName: "authCode"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "authCode"
          KeyType: "HASH"
      TimeToLiveSpecification:
        AttributeName: "ttl"
        Enabled: true
      SSESpecification:
        # checkov:skip=CKV_AWS_119: Implement Customer Managed Keys in PYIC-1391
        SSEEnabled: true
        SSEType: KMS

  AccessTokensTable:
    Type: AWS::DynamoDB::Table
    Properties:
      # checkov:skip=CKV_AWS_28: Point in time recovery is not necessary for this table.
      TableName: !Sub "access-tokens-${Environment}"
      BillingMode: "PAY_PER_REQUEST"
      AttributeDefinitions:
        - AttributeName: "accessToken"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "accessToken"
          KeyType: "HASH"
      TimeToLiveSpecification:
        AttributeName: "ttl"
        Enabled: true
      SSESpecification:
        # checkov:skip=CKV_AWS_119: Implement Customer Managed Keys in PYIC-1391
        SSEEnabled: true
        SSEType: KMS

  SessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      # checkov:skip=CKV_AWS_28: Point in time recovery is not necessary for this table.
      TableName: !Sub "sessions-${Environment}"
      BillingMode: "PAY_PER_REQUEST"
      AttributeDefinitions:
        - AttributeName: "ipvSessionId"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "ipvSessionId"
          KeyType: "HASH"
      TimeToLiveSpecification:
        AttributeName: "ttl"
        Enabled: true
      SSESpecification:
        # checkov:skip=CKV_AWS_119: Implement Customer Managed Keys in PYIC-1391
        SSEEnabled: true
        SSEType: KMS

  LoggingKmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action:
              - "kms:Encrypt*"
              - "kms:Decrypt*"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:Describe*"
            Resource: "*"
            Condition:
              ArnLike:
                "kms:EncryptionContext:aws:logs:arn": !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"

Outputs:
  IPVCorePrivateAPIGatewayID:
    Description: Core Back Private API Gateway ID
    Export:
      Name: !Sub "${AWS::StackName}-IPVCorePrivateAPIGatewayID"
    Value: !Ref IPVCorePrivateAPI
  IPVCoreExternalAPIGatewayID:
    Description: Core Back External API Gateway ID
    Export:
      Name: !Sub "${AWS::StackName}-IPVCoreExternalAPIGatewayID"
    Value: !Ref IPVCoreExternalAPI
